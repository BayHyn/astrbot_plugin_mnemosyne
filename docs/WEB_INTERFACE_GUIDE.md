# Mnemosyne Web 可视化界面使用指南

## 🌟 功能概述

Mnemosyne 插件提供了一个独立的 Web 可视化管理界面，让您可以通过浏览器直观地管理和查看长期记忆数据。

### 主要功能

- 📊 **数据统计**: 实时显示记忆总数、会话数、人格数等统计信息
- 🔍 **记忆浏览**: 分页浏览所有记忆数据，支持搜索和过滤
- 📈 **可视化图表**: 时间分布图和会话分布图
- 🗑️ **数据管理**: 删除单条记忆或整个会话的记忆
- 🔒 **安全认证**: 可选的访问令牌认证保护

## 🚀 快速开始

### 1. 启用 Web 界面

在 AstrBot 配置界面中找到 Mnemosyne 插件配置，设置以下选项：

```json
{
  "web_interface": {
    "enabled": true,
    "host": "127.0.0.1",
    "port": 8765,
    "auth_enabled": true,
    "access_token": ""
  }
}
```

### 2. 启动 Web 服务

使用以下命令启动 Web 界面：

```
/memory web_start
```

### 3. 访问界面

在浏览器中打开显示的访问地址，例如：
```
http://127.0.0.1:8765
```

### 4. 登录认证

如果启用了认证（默认启用），首次访问时会显示登录界面：

1. 输入启动Web界面时显示的访问令牌
2. 点击"验证并登录"按钮
3. 登录成功后，令牌会自动保存在浏览器中
4. 后续访问无需重新输入令牌（除非清除浏览器数据）

## 📋 命令参考

### Web 界面管理命令

| 命令 | 权限 | 功能 |
|------|------|------|
| `/memory web_start` | 管理员 | 启动 Web 界面 |
| `/memory web_stop` | 管理员 | 停止 Web 界面 |
| `/memory web_status` | 所有用户 | 查看 Web 界面状态 |
| `/memory web_keepalive` | 管理员 | 重置空闲时间 |

### 使用示例

```bash
# 启动 Web 界面
/memory web_start

# 查看状态
/memory web_status

# 停止 Web 界面
/memory web_stop
```

## ⚙️ 配置选项

### Web 界面配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | bool | false | 是否启用 Web 界面 |
| `host` | string | "127.0.0.1" | 监听地址 |
| `port` | int | 8765 | 监听端口 |
| `auth_enabled` | bool | true | 是否启用认证 |
| `access_token` | string | "" | 访问令牌（留空自动生成） |
| `auto_stop_enabled` | bool | true | 是否启用自动停止 |
| `idle_timeout_minutes` | int | 30 | 空闲超时时间（分钟） |

### 监听地址说明

- `127.0.0.1`: 仅本机可访问（推荐）
- `0.0.0.0`: 允许外部网络访问（需要防火墙配置）

### 端口选择

- 确保选择的端口未被其他程序占用
- 避免使用系统保留端口（1-1023）
- 推荐使用 8000-9999 范围内的端口

### 自动停止配置

- `auto_stop_enabled`: 启用后Web服务器会在长时间无访问时自动停止
- `idle_timeout_minutes`: 设置空闲超时时间，默认30分钟
- 自动停止有助于节省系统资源和提高安全性

## 🔒 安全认证

### 认证机制

Web 界面支持基于 Bearer Token 的认证机制：

1. **自动生成令牌**: 如果未配置 `access_token`，系统会自动生成一个随机令牌
2. **手动设置令牌**: 可以在配置中手动设置访问令牌
3. **禁用认证**: 设置 `auth_enabled: false` 可禁用认证（不推荐）

### 获取访问令牌

启动 Web 界面后，访问令牌会显示在命令输出中：

```
✅ Web界面启动成功！
🌐 访问地址: http://127.0.0.1:8765
🔑 访问令牌: your-access-token-here
💡 提示：首次访问需要输入上述访问令牌进行认证
```

### 登录流程

1. **首次访问**: 浏览器会显示登录界面，要求输入访问令牌
2. **输入令牌**: 将上述命令输出中的访问令牌复制粘贴到登录框
3. **自动保存**: 登录成功后，令牌会保存在浏览器本地存储中
4. **后续访问**: 无需重新输入令牌，除非：
   - 清除了浏览器数据
   - 令牌已过期或被更改
   - 手动退出登录

### API 直接访问

如果需要通过 API 直接访问，请在请求头中添加：

```
Authorization: Bearer your-access-token-here
```

## ⏰ 自动停止功能

### 工作原理

Web 界面具有智能的自动停止功能：

1. **访问监控**: 每次访问Web界面时都会更新最后访问时间
2. **空闲检测**: 后台监控线程每分钟检查一次空闲时间
3. **自动停止**: 超过设定的空闲时间后自动停止服务器
4. **资源释放**: 停止时会清理所有相关资源和线程

### 触发条件

- **AstrBot停止**: 当AstrBot停止时，Web界面会自动停止
- **空闲超时**: 超过配置的空闲时间（默认30分钟）无任何访问
- **手动停止**: 使用 `/memory web_stop` 命令

### 管理命令

```bash
# 查看当前状态（包括剩余时间）
/memory web_status

# 重置空闲时间（延长运行时间）
/memory web_keepalive

# 手动停止
/memory web_stop
```

## 🎨 界面功能

### 主要区域

1. **状态概览**: 顶部显示总记忆数、会话数、人格数和数据库类型
2. **记忆列表**: 左侧显示分页的记忆数据，支持搜索和过滤
3. **统计图表**: 右侧显示时间分布图和会话分布图

### 搜索和过滤

- **文本搜索**: 在搜索框中输入关键词搜索记忆内容
- **会话过滤**: 选择特定会话查看该会话的记忆
- **分页浏览**: 支持 10/20/50 条每页的分页显示

### 数据管理

- **删除记忆**: 点击记忆项右侧的删除按钮
- **删除会话**: 在会话过滤器中选择会话后批量删除
- **确认操作**: 所有删除操作都需要确认

## 📊 API 接口

Web 界面提供了完整的 REST API：

### 认证接口

- `GET /api/auth/token` - 获取认证信息

### 状态接口

- `GET /api/status` - 获取插件状态
- `GET /api/statistics` - 获取统计信息

### 数据接口

- `GET /api/collections` - 获取集合列表
- `GET /api/memories` - 获取记忆数据（支持分页、搜索、过滤）
- `DELETE /api/memories/{id}` - 删除指定记忆
- `DELETE /api/memories/session/{session_id}` - 删除会话记忆

## 🔧 故障排除

### 常见问题

**Q: Web 界面无法启动 - 端口被占用**
A:
- 启用自动端口选择：在配置中设置 `auto_port_selection: true`
- 手动更换端口：修改配置中的 `port` 值
- 清理资源：使用 `/memory web_cleanup` 命令

**Q: 重启后访问令牌丢失**
A:
- 每次启动都会生成新令牌，查看启动日志获取新令牌
- 使用 `/memory web_status` 查看当前令牌
- 可在配置中手动设置固定令牌

**Q: 无法访问 Web 界面**
A: 确认防火墙设置，检查监听地址配置

**Q: 认证失败**
A: 检查访问令牌是否正确，或尝试重新生成令牌

**Q: 数据不显示**
A: 确认插件已完全初始化，数据库连接正常

### 日志查看

查看 AstrBot 日志中的 `MnemosyneWeb` 相关信息：

```
[MnemosyneWeb] Web服务器已启动: http://127.0.0.1:8765
[MnemosyneWeb] 生成了新的访问令牌: xxx
```

### 重启服务

如果遇到问题，可以尝试重启 Web 服务：

```bash
/memory web_stop
/memory web_start
```

### 端口问题解决

如果遇到端口占用问题：

```bash
# 方法1: 清理资源后重启
/memory web_cleanup
/memory web_start

# 方法2: 查看当前状态
/memory web_status

# 方法3: 修改配置文件中的端口号
```

## 🎯 最佳实践

### 安全建议

1. **启用认证**: 始终保持 `auth_enabled: true`
2. **本地访问**: 使用 `127.0.0.1` 限制本地访问
3. **定期更换令牌**: 定期更新访问令牌
4. **防火墙配置**: 如需外部访问，配置适当的防火墙规则

### 性能优化

1. **分页大小**: 根据数据量调整分页大小
2. **搜索优化**: 使用具体关键词进行搜索
3. **定期清理**: 定期清理不需要的记忆数据

### 使用建议

1. **数据备份**: 在大量删除操作前备份数据
2. **监控状态**: 定期检查 Web 界面状态
3. **合理使用**: 避免频繁的删除操作影响性能

## 📝 更新日志

### v0.6.0
- 首次发布 Web 可视化界面
- 支持记忆数据浏览和管理
- 集成安全认证机制
- 提供完整的 REST API

---

如有问题或建议，请查看插件文档或联系开发者。
